<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šè¡Œäº‹æ›†</title>
    <style>
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        /* æ§åˆ¶åˆ— */
        .controls { background: #eef2f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; border-left: 5px solid #4285f4;}
        .controls input, .controls select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        label { font-weight: bold; color: #444; }
        
        button { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; transition: 0.2s; font-size: 16px; }
        .btn-primary { background-color: #4285f4; color: white; font-weight: bold; }
        .btn-primary:hover { background-color: #3367d6; }
        .btn-sec { background-color: #fff; border: 1px solid #ccc; color: #555; }
        .btn-sec:hover { background-color: #f0f0f0; }
        .btn-active { background-color: #333; color: white; border: 1px solid #333; }

        /* æ¨™é¡Œ */
        .header-title { text-align: center; margin: 10px 0 20px 0; color: #2c3e50; font-size: 2em; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 15px;}
        
        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 10px; }
        th:nth-child(1) { width: 120px; }  
        th:nth-child(2) { width: 35%; }    
        th:nth-child(3) { width: auto; }   

        th { background-color: #4285f4; color: white; padding: 15px; text-align: center; font-size: 1.1em; border: 1px solid #3367d6; }
        td { padding: 15px; border: 1px solid #ccc; vertical-align: middle; word-wrap: break-word; line-height: 1.6; }
        
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e8f0fe; }

        .col-date { font-weight: bold; color: #d32f2f; text-align: center; background-color: #fff8e1; }
        .col-title { font-weight: bold; color: #1a237e; }
        .col-desc { color: #444; }

        .status-box { padding: 40px; text-align: center; color: #666; background: #fafafa; border: 1px dashed #ccc; font-size: 1.2em;}
        .error-msg { color: red; background: #ffebee; border: 1px solid #ef5350; }

        /* å­—é«”å¤§å° */
        .font-normal { font-size: 16px; }
        .font-large { font-size: 20px; } 
        .font-xl { font-size: 24px; }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <label>æ—¥æœŸç¯„åœï¼š</label>
        <input type="date" id="fetchStart" value="2025-10-01">
        <span>è‡³</span>
        <input type="date" id="fetchEnd" value="2026-01-31">
        <button class="btn-primary" onclick="startDataUpdate()">ğŸ”„ æ›´æ–°è³‡æ–™åº«</button>
    </div>

    <div class="controls" style="border-left-color: #34a853;">
        <button class="btn-sec" onclick="shiftDate(-1)">â® ä¸Šä¸€é </button>
        <button class="btn-sec" onclick="shiftDate(1)">ä¸‹ä¸€é  â¯</button>
        <button class="btn-sec" onclick="goToToday()">å›åˆ°ä»Šå¤©</button>
        
        <label style="margin-left: 15px;">å­—é«”ï¼š</label>
        <select id="fontSizeSelect" onchange="updateFontSize()">
            <option value="font-normal">ä¸€èˆ¬ (16px)</option>
            <option value="font-large" selected>å¤§ (20px)</option>
            <option value="font-xl">ç‰¹å¤§ (24px)</option>
        </select>

        <div style="margin-left: auto;">
            <button id="btnWeek" class="btn-sec btn-active" onclick="switchView('week')">é€±æª¢è¦–</button>
            <button id="btnMonth" class="btn-sec" onclick="switchView('month')">æœˆæª¢è¦–</button>
        </div>
    </div>

    <div class="header-title" id="displayTitle">...</div>

    <div id="contentArea">
        <div class="status-box">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>
</div>

<script>
    // ============================================================
    // âš ï¸âš ï¸âš ï¸ è«‹åœ¨ä¸‹æ–¹é›™å¼•è™Ÿ "" ä¹‹é–“è²¼ä¸Šç¶²å€ âš ï¸âš ï¸âš ï¸
    // æ­£ç¢ºç¯„ä¾‹ï¼š const GAS_API_URL = "https://script.google.com/...";
    // éŒ¯èª¤ç¯„ä¾‹ï¼š const GAS_API_URL = https://script.google.com/...;  (å°‘äº†å¼•è™Ÿæœƒç•¶æ©Ÿï¼)
    // ============================================================
    
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwgdGjtsqNQYywpAUp3aGKx4pp0Q0P1m4LJ3MCWJmAXwWRAP8R6vZgRjlGYPoNx0yPF/exec"; 

    // ============================================================

    let allEvents = [];
    let currentViewDate = new Date(); 
    let viewMode = 'week'; 

    // ç¶²é è¼‰å…¥æ™‚åŸ·è¡Œ
    window.onload = function() {
        // 1. å…ˆæª¢æŸ¥ç¶²å€æ ¼å¼æ˜¯å¦æ­£ç¢º
        if (typeof GAS_API_URL === 'undefined' || !GAS_API_URL) {
            showError("åš´é‡çš„èªæ³•éŒ¯èª¤ï¼šGAS_API_URL è®Šæ•¸éºå¤±æˆ–æ ¼å¼éŒ¯èª¤ã€‚");
            return;
        }
        
        // 2. å˜—è©¦æ¸²æŸ“ä»‹é¢
        try {
            renderView();
            startDataUpdate(); // è‡ªå‹•é–‹å§‹æŠ“å–
        } catch (e) {
            console.error(e);
            showError("ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤ï¼š" + e.message);
        }
    };

    function startDataUpdate() {
        const box = document.getElementById('contentArea');
        
        // é˜²å‘†æª¢æŸ¥ï¼šç¶²å€æ˜¯å¦é‚„æ˜¯é è¨­æ–‡å­—ï¼Ÿ
        if(GAS_API_URL.includes("è«‹åœ¨æ­¤è²¼ä¸Š")) {
            alert("ã€æé†’ã€‘\næ‚¨ä¼¼ä¹é‚„æ²’è²¼ä¸Š GAS ç¶²å€å–”ï¼\nè«‹é–‹å•Ÿ HTML æª”æ¡ˆï¼Œæ‰¾åˆ° GAS_API_URL ä¸¦è²¼ä¸Šç¶²å€ã€‚");
            showError("è«‹å…ˆè¨­å®š GAS ç¶²å€ï¼Œæ‰èƒ½è®€å–è³‡æ–™ã€‚");
            return;
        }

        const start = document.getElementById('fetchStart').value;
        const end = document.getElementById('fetchEnd').value;
        
        box.innerHTML = '<div class="status-box" style="color:#4285f4;">æ­£åœ¨é€£ç·šè®€å–è³‡æ–™ï¼Œè«‹ç¨å€™...</div>';

        fetch(`${GAS_API_URL}?start=${start}&end=${end}`)
            .then(res => res.json())
            .then(json => {
                if(json.status === 'success') {
                    allEvents = json.data;
                    renderView();
                    // å¦‚æœæŠ“å›ä¾†æ˜¯ç©ºçš„
                    if (allEvents.length === 0) {
                        box.innerHTML = '<div class="status-box">é€£ç·šæˆåŠŸï¼Œä½†æŒ‡å®šç¯„åœå…§æ²’æœ‰ä»»ä½•è³‡æ–™ã€‚</div>';
                    }
                } else {
                    showError("å¾Œç«¯å›å‚³éŒ¯èª¤ï¼š" + json.message);
                }
            })
            .catch(err => {
                console.error(err);
                showError("é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
            });
    }

    function renderView() {
        updateBtnStyle();
        let rangeStart, rangeEnd, titleStr;

        if (viewMode === 'week') {
            let day = currentViewDate.getDay();
            rangeStart = new Date(currentViewDate);
            rangeStart.setDate(currentViewDate.getDate() - day);
            rangeStart.setHours(0,0,0,0);
            
            rangeEnd = new Date(rangeStart);
            rangeEnd.setDate(rangeStart.getDate() + 6);
            rangeEnd.setHours(23,59,59,999);
            
            titleStr = `${formatDateSimple(rangeStart)} - ${formatDateSimple(rangeEnd)} (é€±)`;
        } else {
            rangeStart = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth(), 1);
            rangeEnd = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + 1, 0, 23, 59, 59);
            titleStr = `${currentViewDate.getFullYear()} å¹´ ${currentViewDate.getMonth()+1} æœˆ`;
        }

        document.getElementById('displayTitle').innerText = titleStr;

        // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œæˆ–æ˜¯å‰›è¼‰å…¥
        if (allEvents.length === 0) {
            // é€™è£¡ä¸é¡¯ç¤ºå…§å®¹ï¼Œäº¤çµ¦ startDataUpdate çš„ loading ç‹€æ…‹è™•ç†
            return;
        }

        // è§£ææ—¥æœŸä¸¦éæ¿¾
        const filtered = allEvents.filter(evt => {
            let d = parseDate(evt.start);
            if (!d || isNaN(d.getTime())) return false; 
            return d >= rangeStart && d <= rangeEnd;
        });

        filtered.sort((a, b) => parseDate(a.start) - parseDate(b.start));

        // å–å¾—å­—é«”å¤§å°
        let currentFontSize = document.getElementById('fontSizeSelect').value;

        if (filtered.length === 0) {
            document.getElementById('contentArea').innerHTML = '<div class="status-box">æœ¬é é¢ç„¡æ´»å‹•<br><small>è«‹æŒ‰ã€Œä¸Šä¸€é /ä¸‹ä¸€é ã€åˆ‡æ›æ—¥æœŸ</small></div>';
            return;
        }

        let html = `<table class="${currentFontSize}"><thead><tr><th>æ—¥æœŸ</th><th>æ´»å‹•æ¨™é¡Œ</th><th>èªªæ˜</th></tr></thead><tbody>`;
        
        filtered.forEach(evt => {
            let dateObj = parseDate(evt.start);
            let month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            let day = dateObj.getDate().toString().padStart(2, '0');
            
            html += `
                <tr>
                    <td class="col-date">${month}/${day}</td>
                    <td class="col-title">${evt.title}</td>
                    <td class="col-desc">${evt.desc || ''}</td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        document.getElementById('contentArea').innerHTML = html;
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;
        if (dateStr.indexOf('T') !== -1) return new Date(dateStr);
        return new Date(dateStr.replace(/-/g, '/'));
    }

    function showError(msg) {
        document.getElementById('contentArea').innerHTML = `<div class="status-box error-msg">âš ï¸ ${msg}</div>`;
    }

    function updateFontSize() { renderView(); }
    function shiftDate(n) {
        if (viewMode === 'week') {
            currentViewDate.setDate(currentViewDate.getDate() + (n * 7));
        } else {
            currentViewDate.setMonth(currentViewDate.getMonth() + n);
        }
        renderView();
    }
    function goToToday() { currentViewDate = new Date(); renderView(); }
    function switchView(mode) { viewMode = mode; renderView(); }
    function updateBtnStyle() {
        document.getElementById('btnWeek').className = viewMode === 'week' ? 'btn-sec btn-active' : 'btn-sec';
        document.getElementById('btnMonth').className = viewMode === 'month' ? 'btn-sec btn-active' : 'btn-sec';
    }
    function formatDateSimple(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
</script>

</body>
</html>