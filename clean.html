<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教室掃地工作檢查表 (修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        .no-select { user-select: none; -webkit-user-select: none; }
        /* 微動畫：按鈕出現 */
        @keyframes slideUp {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .anim-appear { animation: slideUp 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 圖示組件 ---
        const CheckCircle = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );
        
        const XIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const ClipboardCheck = ({ className, strokeWidth = 2 }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                <path d="m9 14 2 2 4-4"></path>
            </svg>
        );

        // 待加強 (驚嘆號)
        const ClipboardAlert = ({ className, strokeWidth = 2 }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                <line x1="12" y1="11" x2="12" y2="15"></line>
                <line x1="12" y1="19" x2="12.01" y2="19"></line>
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        // --- 資料設定 ---
        const DEFAULT_TASKS = [
            { id: 'task_01', name: '1、2排掃拖地', personnel: '25, 20, 26', completed: false, checkStatus: 'none' },
            { id: 'task_02', name: '3、4排掃拖地', personnel: '1, 10, 8', completed: false, checkStatus: 'none' },
            { id: 'task_03', name: '5、6排掃拖地', personnel: '18, 21, 22', completed: false, checkStatus: 'none' },
            { id: 'task_04', name: '教室前後掃拖', personnel: '3, 4, 5', completed: false, checkStatus: 'none' },
            { id: 'task_05', name: '走廊掃拖地', personnel: '16, 17, 23', completed: false, checkStatus: 'none' },
            { id: 'task_06', name: '後陽台掃地', personnel: '6', completed: false, checkStatus: 'none' },
            { id: 'task_07', name: '拖把用水桶', personnel: '7', completed: false, checkStatus: 'none' },
            { id: 'task_08', name: '講桌前後公布欄', personnel: '19', completed: false, checkStatus: 'none' },
            { id: 'task_09', name: '擦黑板', personnel: '28', completed: false, checkStatus: 'none' },
            { id: 'task_10', name: '走廊窗戶鞋櫃', personnel: '24', completed: false, checkStatus: 'none' },
            { id: 'task_11', name: '老師窗戶落地窗', personnel: '29', completed: false, checkStatus: 'none' },
            { id: 'task_12', name: '前後門及欄杆', personnel: '27', completed: false, checkStatus: 'none' },
            { id: 'task_13', name: '掃具間及回收', personnel: '9, 11, 12', completed: false, checkStatus: 'none' },
        ];

        function App() {
            const [tasks, setTasks] = useState(() => {
                if (typeof window !== 'undefined') {
                    const saved = localStorage.getItem('cleaning_tasks_grid_v2');
                    if (saved) {
                        const parsedSaved = JSON.parse(saved);
                        if (parsedSaved.length === DEFAULT_TASKS.length) {
                             return parsedSaved.map((t, i) => ({
                                ...t,
                                name: DEFAULT_TASKS[i].name,
                                checkStatus: t.checkStatus || (t.checked ? 'approved' : 'none')
                            }));
                        }
                    }
                }
                return DEFAULT_TASKS;
            });

            const [activeTaskId, setActiveTaskId] = useState(null);
            const [showWarning, setShowWarning] = useState(false);
            const [resetting, setResetting] = useState(false);

            // 處理點擊外部關閉選單
            useEffect(() => {
                const handleClickOutside = () => {
                    if (activeTaskId) {
                        setActiveTaskId(null);
                    }
                };

                if (activeTaskId) {
                    window.addEventListener('click', handleClickOutside);
                }
                return () => {
                    window.removeEventListener('click', handleClickOutside);
                };
            }, [activeTaskId]);

            useEffect(() => {
                localStorage.setItem('cleaning_tasks_grid_v2', JSON.stringify(tasks));
            }, [tasks]);

            const toggleCompleted = (taskId) => {
                setTasks(prevTasks => 
                    prevTasks.map(task => {
                        if (task.id !== taskId) return task;
                        const newCompleted = !task.completed;
                        return { ...task, completed: newCompleted };
                    })
                );
            };

            const handleCheckClick = (e, task) => {
                // 阻止事件冒泡，避免觸發 window click 立刻關閉
                e.stopPropagation(); 
                
                if (!task.completed) {
                    setShowWarning(true);
                    setTimeout(() => setShowWarning(false), 1500);
                    return;
                }
                
                if (activeTaskId === task.id) {
                    setActiveTaskId(null);
                } else {
                    setActiveTaskId(task.id);
                }
            };

            const applyCheckStatus = (e, taskId, status) => {
                // 阻止事件冒泡，確保按鈕點擊有效
                e.stopPropagation(); 
                
                setTasks(prevTasks => 
                    prevTasks.map(task => {
                        if (task.id !== taskId) return task;

                        const newCompleted = status === 'improvement' ? false : task.completed;
                        
                        return { 
                            ...task, 
                            checkStatus: status,
                            completed: newCompleted
                        };
                    })
                );
                setActiveTaskId(null);
            };

            const resetAll = () => {
                if (!confirm('確定要重置所有項目嗎？')) return;
                setResetting(true);
                setTimeout(() => {
                    const newTasks = tasks.map(task => ({
                        ...task,
                        completed: false,
                        checkStatus: 'none'
                    }));
                    setTasks(newTasks);
                    setResetting(false);
                }, 200);
            };

            const today = new Date().toLocaleDateString('zh-TW', {
                month: 'numeric',
                day: 'numeric',
                weekday: 'short'
            });

            const completedCount = tasks.filter(t => t.completed).length;
            const approvedCount = tasks.filter(t => t.checkStatus === 'approved').length;

            return (
                <div className="h-full flex flex-col bg-gray-200 p-2 no-select relative">
                    
                    {/* 警告訊息 */}
                    {showWarning && (
                        <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-black bg-opacity-80 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 pointer-events-none anim-appear">
                            <AlertCircle className="w-8 h-8 text-yellow-400" />
                            <span className="text-xl font-bold">請先確認同學已點選「完成」</span>
                        </div>
                    )}

                    {/* 頂部標題列 */}
                    <div className="flex justify-between items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm mb-2 shrink-0 relative z-0">
                        <div className="bg-blue-700 px-3 py-1 rounded-lg text-sm font-medium w-24 text-center hidden sm:block">
                            {today}
                        </div>

                        <div className="flex-1 flex justify-center items-center gap-2">
                            <ClipboardCheck className="w-7 h-7 hidden sm:block" />
                            <h1 className="text-2xl font-bold tracking-wide text-center">
                                教室掃地檢查表
                            </h1>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            <div className="hidden sm:flex gap-3 text-lg font-bold mr-2">
                                <span className="text-green-200">完: {completedCount}</span>
                                <span className="text-purple-200">檢: {approvedCount}</span>
                            </div>
                            <button 
                                onClick={resetAll}
                                disabled={resetting}
                                className="flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg shadow transition-colors"
                            >
                                <RefreshCw className={`w-5 h-5 ${resetting ? 'animate-spin' : ''}`} />
                            </button>
                        </div>
                    </div>

                    {/* 格狀內容區 */}
                    <div className="flex-grow grid grid-cols-4 lg:grid-cols-5 grid-rows-4 lg:grid-rows-3 gap-2 h-full z-0">
                        {tasks.map((task) => {
                            const isActive = activeTaskId === task.id;

                            return (
                                <div 
                                    key={task.id} 
                                    className={`bg-white rounded-xl border-2 shadow-sm flex flex-col overflow-hidden transition-all relative
                                        ${isActive ? 'ring-2 ring-purple-300' : ''}
                                        ${task.checkStatus === 'approved' ? 'border-purple-500 shadow-purple-100' : ''}
                                        ${task.checkStatus === 'improvement' ? 'border-red-400 shadow-red-50' : ''}
                                        ${task.checkStatus === 'none' && task.completed ? 'border-green-400 shadow-green-50' : ''}
                                        ${task.checkStatus === 'none' && !task.completed ? 'border-gray-300' : ''}
                                    `}
                                >
                                    {/* 標題 (加入文字變色邏輯) */}
                                    <div className="bg-gray-50 px-1 flex items-center justify-center h-[32%] border-b border-gray-200">
                                        <div className={`font-bold text-xl sm:text-2xl leading-tight text-center px-1 
                                            ${task.checkStatus === 'improvement' ? 'text-red-600' : 'text-gray-800'}
                                        `}>
                                            {task.name}
                                        </div>
                                    </div>

                                    {/* 人員 */}
                                    <div className="bg-white px-1 flex items-center justify-center h-[14%] border-b border-gray-100">
                                        <span className="inline-block bg-gray-100 text-gray-600 px-2 rounded text-base font-bold">
                                            {task.personnel}
                                        </span>
                                    </div>

                                    {/* 按鈕區 */}
                                    <div className="flex-grow flex divide-x-2 divide-gray-200 h-[54%] relative">
                                        {/* 左邊：完成鈕 */}
                                        <button
                                            onClick={() => toggleCompleted(task.id)}
                                            className={`flex-1 flex items-center justify-center transition-colors active:bg-gray-200
                                                ${task.completed ? 'bg-green-100 text-green-600' : 'bg-white text-gray-300 hover:bg-gray-50'}
                                            `}
                                        >
                                            {task.completed ? (
                                                <CheckCircle className="w-16 h-16 drop-shadow-sm" />
                                            ) : (
                                                <XIcon className="w-12 h-12 opacity-30" />
                                            )}
                                        </button>

                                        {/* 右邊：檢查鈕 (容器) */}
                                        <div className="flex-1 relative">
                                            {isActive ? (
                                                // 展開狀態：顯示兩個小按鈕 (使用絕對定位覆蓋)
                                                <div className="absolute inset-0 flex flex-col z-20 anim-appear bg-white">
                                                    <button 
                                                        onClick={(e) => applyCheckStatus(e, task.id, 'approved')}
                                                        className="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-600 flex items-center justify-center border-b border-purple-200 cursor-pointer"
                                                    >
                                                        <div className="flex items-center gap-1">
                                                            <ClipboardCheck className="w-6 h-6" />
                                                            <span className="font-bold text-lg">通過</span>
                                                        </div>
                                                    </button>
                                                    <button 
                                                        onClick={(e) => applyCheckStatus(e, task.id, 'improvement')}
                                                        className="flex-1 bg-red-100 hover:bg-red-200 text-red-500 flex items-center justify-center cursor-pointer"
                                                    >
                                                        <div className="flex items-center gap-1">
                                                            <ClipboardAlert className="w-6 h-6" />
                                                            <span className="font-bold text-lg">待加強</span>
                                                        </div>
                                                    </button>
                                                </div>
                                            ) : (
                                                // 正常狀態：顯示大按鈕
                                                <button
                                                    onClick={(e) => handleCheckClick(e, task)}
                                                    className={`w-full h-full flex items-center justify-center transition-colors active:bg-gray-200 cursor-pointer
                                                        ${task.checkStatus === 'approved' ? 'bg-purple-100 text-purple-600' : ''}
                                                        ${task.checkStatus === 'improvement' ? 'bg-red-50 text-red-500' : ''}
                                                        ${task.checkStatus === 'none' ? 'bg-white text-gray-200 hover:bg-gray-50' : ''}
                                                    `}
                                                >
                                                    {task.checkStatus === 'approved' && (
                                                        <ClipboardCheck className="w-14 h-14 drop-shadow-sm" strokeWidth={2.5} />
                                                    )}
                                                    {task.checkStatus === 'improvement' && (
                                                        <ClipboardAlert className="w-14 h-14 drop-shadow-sm" strokeWidth={2.5} />
                                                    )}
                                                    {task.checkStatus === 'none' && (
                                                        <ClipboardCheck className="w-10 h-10 opacity-30" strokeWidth={1.5} />
                                                    )}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>